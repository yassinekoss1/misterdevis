{"version":3,"sources":["../src/index.js"],"names":["app","PORT","SLEEP_TIME","use","json","config","__dirname","sysEmail","transport","createTransport","host","port","secure","greetingTimeout","auth","user","pass","sleep","ms","Promise","resolve","setTimeout","sendArtisanMail","email_artisan","nom_artisan","ref","options","from","to","subject","html","sendMail","err","sendParticulierMail","email_particulier","nom_particulier","sendOpMail","email_user","firstname_user","url","get","req","res","status","send","post","artisans","particuliers","ops","body","i","j","k","end","length","particulier","console","log","then","catch","error","artisan","op","listen"],"mappings":"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","file":"index.js","sourcesContent":["import {readFileSync} from 'fs';\nimport {parse} from 'ini';\nimport {resolve} from 'path';\nimport express from \"express\";\nimport bodyParser from \"body-parser\";\nimport nodemailer from \"nodemailer\";\n\nimport cors from \"cors\";\n\n\nconst app = express();\nconst PORT = 9090;\nconst SLEEP_TIME = 1500;\n\napp.use(bodyParser.json());\napp.use(cors());\n\nconst config = parse(readFileSync(resolve(__dirname, '../../application/configs/application.ini'), 'utf-8'));\n\nconst sysEmail = `${config['production']['system.email.name']} <${config['production']['system.email.address']}>`;\n\nconst transport = nodemailer.createTransport({\n\thost: config['production']['resources.mail.transport.host'],\n\tport: config['production']['resources.mail.transport.port'],\n\tsecure: config['production']['resources.mail.transport.secure'],\n\tgreetingTimeout: 60000,\n\tauth: {\n\t\tuser: config['production']['resources.mail.transport.username'],\n\t\tpass: config['production']['resources.mail.transport.password']\n\t}\n});\n\n\nconst sleep = ms => new Promise(resolve => setTimeout(resolve, ms));\n\nconst sendArtisanMail = async ({email_artisan, nom_artisan}, ref) => {\n\tif (!email_artisan) return null;\n\t\n\tconst options = {\n\t\tfrom: sysEmail,\n\t\tto: email_artisan,\n\t\tsubject: 'Nouvelle demande de devis',\n\t\thtml: `\n        <div style=\"width: 650px; margin: 80px auto;\">\n            <div style=\"text-align: center; padding: 10px;\"><img src=\"http://www.webonline2018.com/resources_fo_ehcg/img/company_logo_1.jpg\" /></div>\n            <h1 style=\"background-color:#0184c2;padding: 50px;color:#fff;text-align: center;\">Une nouvelle demande de devis a été mise en ligne</h1>\n            <p>Bonjour ${nom_artisan},</p>\n            <p>Nous vous informons qu'une nouvelle demande de devis concernant votre activité et votre zone d'intervention a été publiée dans la plateforme.</p>\n            <p>Vous pouvez la consulter dans votre espace pro.</p>\n            <h1>Demande N°: ${ref}</h1>\n            <p> A très bientôt</p>\n            <p>L'équipe <a href=\"http://mister-devis.com\">mister-devis.com</a></p>\n        </div>\n        `\n\t};\n\ttransport.sendMail(options, err => {\n\t\tif (err) throw err;\n\t\thtml: `\n        <div style=\"width: 650px; margin: 80px auto;\">\n            <div style=\"text-align: center; padding: 10px;\"><img src=\"http://www.webonline2018.com/resources_fo_ehcg/img/company_logo_1.jpg\" /></div>\n            <h1 style=\"background-color:#0184c2;padding: 50px;color:#fff;text-align: center;\">Une nouvelle demande de devis a été mise en ligne</h1>\n            <p>Bonjour ${nom_artisan},</p>\n            <p>Nous vous informons qu'une nouvelle demande de devis concernant votre activité et votre zone d'intervention a été publiée dans la plateforme.</p>\n            <p>Vous pouvez la consulter dans votre espace pro.</p>\n            <h1>Demande N°: ${ref}</h1>\n            <p> A très bientôt</p>\n            <p>L'équipe <a href=\"http://mister-devis.com\">mister-devis.com</a></p>\n        </div>\n        `\n\t});\n};\n\nconst sendParticulierMail = async ({email_particulier, nom_particulier}, ref) => {\n\tif (!email_particulier) return null;\n\t\n\tconst options = {\n\t\tfrom: sysEmail,\n\t\tto: email_particulier,\n\t\tsubject: 'Confirmation de votre demande de devis',\n\t\thtml: `\n\t\t\t\t<div style=\"width: 650px; margin: 80px auto;\">\n\t\t\t\t\t<div style=\"text-align: center; padding: 10px;\"><img src=\"http://www.webonline2018.com/resources_fo_ehcg/img/company_logo_1.jpg\" /></div>\n\t\t\t\t\t<h1 style=\"background-color:#0184c2;padding: 50px;color:#fff;text-align: center;\">Confirmation de votre demande de devis</h1>\n\t\t\t\t\t<p>Bonjour ${nom_particulier},</p>\n\t\t\t\t\t<p>Nous vous confirmons la réception de votre demande de devis.</p>\n\t\t\t\t\t<p>Prochainement un de nos conseillers vous contactera afin de recueillir l'ensemble des informations concernant votre projet.</p>\n\t\t\t\t\t<h1>Demande N°: ${ref}</h1>\n\t\t\t\t\t<p> A très bientôt</p>\n\t\t\t\t\t<p>L'équipe <a href=\"http://mister-devis.com\">mister-devis.com</a></p>\n\t\t\t\t</div>\n        `\n\t};\n\ttransport.sendMail(options, err => {\n\t\tif (err) throw err;\n\t});\n};\n\nconst sendOpMail = async ({email_user, firstname_user}, url, ref) => {\n\tif (!email_user) return null;\n\t\n\tconst options = {\n\t\tfrom: sysEmail,\n\t\tto: email_user,\n\t\tsubject: 'Confirmation de votre demande de devis',\n\t\thtml: `\n\t\t\t\t<div style=\"width: 650px; margin: 80px auto;\">\n\t\t\t\t\t<div style=\"text-align: center; padding: 10px;\"><img src=\"http://www.webonline2018.com/resources_fo_ehcg/img/company_logo_1.jpg\" /></div>\n\t\t\t\t\t<h1 style=\"background-color:#0184c2;padding: 50px;color:#fff;text-align: center;\">Confirmation de votre demande de devis</h1>\n\t\t\t\t\t<p>Bonjour ${firstname_user},</p>\n\t\t\t\t\t<p>Nous vous confirmons la réception de votre demande de devis.</p>\n\t\t\t\t\t<p>Prochainement un de nos conseillers vous contactera afin de recueillir l'ensemble des informations concernant votre projet.</p>\n\t\t\t\t\t<h1>Demande N°: ${ref}</h1>\n\t\t\t\t\t<p><a href=\"${url}\">Cliquez ici pour accèder au backoffice</a></p>\n\t\t\t\t\t<p>A très bientôt</p>\n\t\t\t\t\t<p>L'équipe <a href=\"http://mister-devis.com\">mister-devis.com</a></p>\n\t\t\t\t</div>\n        `\n\t};\n\ttransport.sendMail(options, err => {\n\t\tif (err) throw err;\n\t});\n};\n\napp.get('/', (req, res) => {\n\treturn res.status(403).send('<h1 style=\"font-size:46px; text-align: center\">403 Forbidden</h1><hr />');\n});\n\n\napp.post('/', async (req, res) => {\n\t\n\tconst {artisans, particuliers, ops, ref, url} = req.body;\n\tlet i = 0, j = 0, k = 0;\n\t\n\tres.end(); // send back empty response\n\t\n\t// if there are particulier recepients we loop thru them\n\tif (particuliers && particuliers.length) {\n\t\twhile (true) {\n\t\t\tif (i >= particuliers.length)\n\t\t\t\tbreak;\n\t\t\t\n\t\t\t\n\t\t\tconst particulier = particuliers[i];\n\t\t\tconsole.log(particulier);\n\t\t\t\n\t\t\tif (typeof particulier !== \"undefined\") {\n\t\t\t\tif (particulier['email_particulier']) {\n\t\t\t\t\tawait sleep(SLEEP_TIME); // waiting a bit before sending the next email\n\t\t\t\t\tsendParticulierMail(particulier, ref)\n\t\t\t\t\t\t.then(() => console.log(`${particulier['email_particulier']} particulier OK`))\n\t\t\t\t\t\t.catch(err => console.error(err));\n\t\t\t\t}\n\t\t\t}\n\t\t\ti++;\n\t\t}\n\t}\n\t\n\t// if there are artisan recepients we loop thru them\n\tif (artisans && artisans.length) {\n\t\twhile (true) {\n\t\t\tif (j >= artisans.length)\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tconst artisan = artisans[j];\n\t\t\t\n\t\t\tif (typeof artisan !== \"undefined\") {\n\t\t\t\tif (artisan['email_artisan']) {\n\t\t\t\t\tawait sleep(SLEEP_TIME); // waiting a bit before sending the next email\n\t\t\t\t\tsendArtisanMail(artisan, ref)\n\t\t\t\t\t\t.then(() => console.log(`${artisan['email_artisan']} artisan OK`))\n\t\t\t\t\t\t.catch(err => console.error(err));\n\t\t\t\t}\n\t\t\t}\n\t\t\tj++;\n\t\t}\n\t}\n\t\n\t\n\t// if there are operators recepients we loop thru them\n\tif (ops && ops.length) {\n\t\twhile (true) {\n\t\t\tif (j >= ops.length)\n\t\t\t\tbreak;\n\t\t\t\n\t\t\tconst op = ops[j];\n\t\t\t\n\t\t\tif (typeof op !== \"undefined\") {\n\t\t\t\tif (op['email_user']) {\n\t\t\t\t\tawait sleep(SLEEP_TIME); // waiting a bit before sending the next email\n\t\t\t\t\tsendOpMail(op, url, ref)\n\t\t\t\t\t\t.then(() => console.log(`${op['email_user']} User OK`))\n\t\t\t\t\t\t.catch(err => console.error(err));\n\t\t\t\t}\n\t\t\t}\n\t\t\tj++;\n\t\t}\n\t}\n\t\n});\n\napp.listen(PORT, () => console.log(`Server running on port ${PORT}`));\n"]}